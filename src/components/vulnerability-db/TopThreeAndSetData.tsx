"use client";
import { useEffect, useMemo } from "react";
import TopThreeItem from "./TopThreeItem";
import { useVulnerabilityStore } from "@/store/useVulnerabilityStore";
import TopThreeLoading from "./TopThreeLoading";
import fetchPinnedId from "@/firebase/fetchPinnedId";
import { usePinnedStore } from "@/store/usePinnedStore";
import { useSession } from "next-auth/react";

function TopThreeAndSetData(): JSX.Element {
  const { data, setData, loaded, setLoaded } = useVulnerabilityStore();
  const { data: session } = useSession();
  console.log(session);
  const {
    setPinnedId,
    loaded: pinLoaded,
    setLoaded: setPinLoaded,
  } = usePinnedStore();

  const fetchData = async () => {
    try {
      const response = await fetch("/api/vulnerabilities");
      const result = await response.json();
      setData(result);
      setLoaded(true);
    } catch (error) {
      console.error("Failed to fetch vulnerabilities", error);
    }
  };
  const pinnedData = async () => {
    try {
      const pinId = await fetchPinnedId(session);
      console.log(pinId);
      setPinnedId(pinId);
      setPinLoaded(true);
    } catch (error) {
      console.error("Failed to fetch vulnerabilities", error);
    }
  };

  useEffect(() => {
    if (!loaded) {
      fetchData();
    }
    if (!pinLoaded) {
      pinnedData();
    }
  }, []);

  const topThreeItems = useMemo(() => {
    return <TopThreeItem />;
  }, [data]);

  return <>{data.length ? topThreeItems : <TopThreeLoading />}</>;
}

export default TopThreeAndSetData;
